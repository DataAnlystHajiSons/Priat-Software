<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Actual Details</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    select, input {
      padding: 5px;
      margin: 5px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f4f4f4;
    }
    .btn {
      padding: 10px 15px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px; /* Added for better aesthetics */
    }
    .btn:hover {
      background-color: #0056b3;
    }
    input[readonly] {
      background-color: #e9e9e9;
    }
  </style>
</head>
<body>

  <h2>Actual Details</h2>

  <label for="siteSelect">Select Site:</label>
  <select id="siteSelect"></select>

  <button class="btn" onclick="addRow()">Add Item</button>
  <button class="btn" onclick="saveChanges()">Save Changes</button>

  <table id="actualTable">
    <thead>
      <tr>
        <th>Item Type</th>
        <th>Item Description</th>
        <th>Standards</th>
        <th>Specifications</th>
        <th>Unit</th>
        <th>Qty</th>
        <th>Unit Rate (PKR)</th>
        <th>Cost (PKR)</th>
        <th>GST Rate (%)</th>
        <th>GST (PKR)</th>
        <th>Total (PKR)</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="actualTableBody"></tbody>
  </table>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <script>
    // Supabase client initialization
    const { createClient } = supabase;
    const supabaseUrl = 'https://mxktarizsqttwwzbqgld.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im14a3Rhcml6c3F0dHd3emJxZ2xkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2NDA3MTMsImV4cCI6MjA2ODIxNjcxM30.UKA9NjB8mlxYJjzaC0cMnPGREcEAf-NQ3AeRWNWeuP8';
    const supabaseClient = createClient(supabaseUrl, supabaseKey);

    // DOM elements
    const siteSelect = document.getElementById('siteSelect');
    const actualTableBody = document.getElementById('actualTableBody');

    // --- Fetch and Populate Sites ---
    async function fetchSites() {
      const { data, error } = await supabaseClient
        .from('site_details')
        .select('id, site_name');

      if (error) {
        console.error('Error loading sites:', error);
        return;
      }

      siteSelect.innerHTML = '<option value="">-- Select Site --</option>';
      data.forEach(site => {
        const option = document.createElement('option');
        option.value = site.id;
        option.textContent = site.site_name;
        siteSelect.appendChild(option);
      });
    }

    // --- Event Listener for Site Selection ---
    siteSelect.addEventListener('change', async () => {
      actualTableBody.innerHTML = ''; // Clear existing rows
      const siteId = siteSelect.value;
      if (!siteId) return; // Do nothing if no site is selected

      const { data, error } = await supabaseClient
        .from('actual_details')
        .select('*')
        .eq('site_id', siteId);

      if (error) {
        console.error('Error fetching Actual details:', error);
        return;
      }

      data.forEach(row => addRow(row));
    });

    // --- Add Row Function ---
    function addRow(row = {}) {
      const tr = document.createElement('tr');
      // Use a consistent way to mark new rows. A data attribute is good.
      tr.setAttribute('data-is-new', row.id ? 'false' : 'true');
      tr.setAttribute('data-id', row.id || ''); // Store existing ID if available

      const itemTypes = ['Material', 'Expense'];
      const statusOptions = ['Approved', 'Pending'];

      tr.innerHTML = `
        <td>
          <select name="item_type">
            ${itemTypes.map(t => `<option value="${t}" ${row.item_type === t ? 'selected' : ''}>${t}</option>`).join('')}
          </select>
        </td>
        <td><input type="text" name="item_description" value="${row.item_description || ''}"></td>
        <td><input type="text" name="standards" value="${row.standards || ''}"></td>
        <td><input type="text" name="specifications" value="${row.specifications || ''}"></td>
        <td><input type="text" name="unit" value="${row.unit || ''}"></td>
        <td><input type="number" name="qty" value="${row.qty || 0}" oninput="calculateRow(this)"></td>
        <td><input type="number" name="unit_rate" value="${row.unit_rate || 0}" oninput="calculateRow(this)"></td>
        <td><input type="number" name="cost" value="${row.cost || 0}" readonly></td>
        <td><input type="number" name="gst_rate" value="${row.gst_rate || 0}" oninput="calculateRow(this)"></td>
        <td><input type="number" name="gst" value="${row.gst || 0}" readonly></td>
        <td><input type="number" name="total" value="${row.total || 0}" readonly></td>
        <td>
          <select name="status">
            ${statusOptions.map(s => `<option value="${s}" ${row.status === s ? 'selected' : ''}>${s}</option>`).join('')}
          </select>
        </td>
      `;
      actualTableBody.appendChild(tr);

      // Immediately calculate for loaded rows as well
      calculateRow(tr.querySelector('[name="qty"]'));
    }

    // --- Calculate Row Values ---
    function calculateRow(inputElement) {
      const row = inputElement.closest('tr');
      const qty = parseFloat(row.querySelector('[name="qty"]').value) || 0;
      const unitRate = parseFloat(row.querySelector('[name="unit_rate"]').value) || 0;
      const gstRate = parseFloat(row.querySelector('[name="gst_rate"]').value) || 0;

      const cost = qty * unitRate;
      const gst = (cost * gstRate) / 100;
      const total = cost + gst;

      row.querySelector('[name="cost"]').value = cost.toFixed(2);
      row.querySelector('[name="gst"]').value = gst.toFixed(2);
      row.querySelector('[name="total"]').value = total.toFixed(2);
    }

    // --- Save Changes Function ---
    async function saveChanges() {
      const siteId = siteSelect.value;
      if (!siteId) {
        alert('Please select a site first.');
        return;
      }

      const rowsToInsert = [];
      const rowsToUpdate = [];

      actualTableBody.querySelectorAll('tr').forEach(row => {
        const record = {
          site_id: siteId,
          item_type: row.querySelector('[name="item_type"]').value,
          item_description: row.querySelector('[name="item_description"]').value,
          standards: row.querySelector('[name="standards"]').value,
          specifications: row.querySelector('[name="specifications"]').value,
          unit: row.querySelector('[name="unit"]').value,
          qty: parseFloat(row.querySelector('[name="qty"]').value) || 0,
          unit_rate: parseFloat(row.querySelector('[name="unit_rate"]').value) || 0,
          cost: parseFloat(row.querySelector('[name="cost"]').value) || 0,
          gst_rate: parseFloat(row.querySelector('[name="gst_rate"]').value) || 0,
          gst: parseFloat(row.querySelector('[name="gst"]').value) || 0,
          total: parseFloat(row.querySelector('[name="total"]').value) || 0,
          status: row.querySelector('[name="status"]').value,
          timestamp: new Date().toISOString()
        };

        if (row.getAttribute('data-is-new') === 'true') {
          // For new rows, generate a UUID and add to insert array
          record.id = crypto.randomUUID();
          rowsToInsert.push(record);
        } else {
          // For existing rows, add ID and to update array
          record.id = row.getAttribute('data-id');
          rowsToUpdate.push(record);
        }
      });

      let hasError = false;

      // Insert new rows
      if (rowsToInsert.length > 0) {
        const { error: insertError } = await supabaseClient.from('actual_details').insert(rowsToInsert);
        if (insertError) {
          alert('Error inserting new rows: ' + insertError.message);
          hasError = true;
        }
      }

      // Update existing rows (Supabase upsert can handle this, or individual updates)
      // For simplicity, let's assume we update one by one or use upsert if all fields are present
      // A more robust solution might check for changes before updating
      for (const record of rowsToUpdate) {
        const { error: updateError } = await supabaseClient
          .from('actual_details')
          .update(record)
          .eq('id', record.id);
        if (updateError) {
          alert(`Error updating row ${record.id}: ${updateError.message}`);
          hasError = true;
          break; // Stop on first error
        }
      }

      if (!hasError) {
        alert('Changes saved successfully!');
        // Refresh table to reflect changes (and mark new rows as not new)
        siteSelect.dispatchEvent(new Event('change'));
      }
    }

    // --- Initial Data Load ---
    fetchSites();
  </script>
</body>
</html>